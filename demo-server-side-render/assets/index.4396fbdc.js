var K=Object.defineProperty,z=Object.defineProperties;var G=Object.getOwnPropertyDescriptors;var S=Object.getOwnPropertySymbols;var Z=Object.prototype.hasOwnProperty,U=Object.prototype.propertyIsEnumerable;var v=(t,e,r)=>e in t?K(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,p=(t,e)=>{for(var r in e||(e={}))Z.call(e,r)&&v(t,r,e[r]);if(S)for(var r of S(e))U.call(e,r)&&v(t,r,e[r]);return t},x=(t,e)=>z(t,G(e));var o=(t,e,r)=>(v(t,typeof e!="symbol"?e+"":e,r),r);import{r as y,i as C,h as W,t as q,a as X,b as O,e as A,K as Y,c as ee,n as te,g as E,o as re,d as se,f as w,j as L,F as P,k as ne,l as b,m as ie,p as oe,q as j,s as ae}from"./vendor.2716932a.js";const ue=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const u of i.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&s(u)}).observe(document,{childList:!0,subtree:!0});function r(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerpolicy&&(i.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?i.credentials="include":n.crossorigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(n){if(n.ep)return;n.ep=!0;const i=r(n);fetch(n.href,i)}};ue();const c={rpcProvider(){throw new Error("must install with rpcProvider before query or call")}},R=new Map;function ce(t,e){const r=new g;t.provide(g.key,r),Object.assign(c,e),t.mixin({created(){if(c.dehydrate||c.hydrate){const i=this.$.render;this.$.render=function(...u){let a=i.apply(this,u);if((!C(a)||typeof a.type!="string")&&(a=W("div",a)),c.hydrate)return a;a.props||(a.props={});const l={},f={};for(const[m,h]of Object.entries(q(this.$.data)))X(h)&&h.value&&h.value.data&&((h.value.stale?f:l)[m]=h.value.data);return a.props["data-dehydrated"]=JSON.stringify(l),a.props["data-stale"]=JSON.stringify(f),a}}const s=this.$.type;let n=s.instanceCount;n||(n=s.instanceCount=O(0)),n.value++},beforeMount(){var u,a;if(!c.hydrate)return;const s=q(this.$.data),n=JSON.parse(((u=this.$el.dataset)==null?void 0:u.dehydrated)||"{}"),i=JSON.parse(((a=this.$el.dataset)==null?void 0:a.stale)||"{}");for(const l of Object.keys(i))s[l].value._query&&s[l].value._query.refresh();for(const[l,f]of Object.entries(p(p({},n),i)))s[l].value={loading:!1,data:f}},unmounted(){this.$.type.instanceCount.value--},async serverPrefetch(){await r.flushing}})}function le(t,e){A(()=>{const r=e();for(const[s,n]of Object.entries(r))if(typeof n=="object")for(const[i,u]of Object.entries(n))t[s][i]=u;else t[s]=n})}function de(t){return B(t.$).proxy}function B(t){return!t.parent||t.parent.type===Y?t:B(t.parent)}function fe(t,e){if(t instanceof d){const r=H(t,e);return ee(()=>{const s=r.value;return{loading:s.loading,data:s.data[0],error:s.error}})}return _(t,e)[0]}function _(t,e){if(t instanceof d)return H(t,e);const r=t;r.instanceCount||(r.instanceCount=O(0)),r.instanceCount.value;const s=[];let n;if(e.$parent)n=e.$parent.$.subTree;else if(e.$root)n=e.$root.$.subTree,delete e.$root;else throw new Error("must provide $parent or $root");return k(s,n,r,e),s}function k(t,e,r,s){if(!!e){if(e.component)e.type===r&&he(e.component.proxy,s)&&t.push(e.component.proxy),k(t,e.component.subTree,r,s);else if(Array.isArray(e.children))for(const n of e.children)C(n)&&k(t,n,r,s)}}function he(t,e){if(!e)return!0;for(const[r,s]of Object.entries(e))if(r==="$parent"){if(t.$.parent.proxy!==s)return!1}else if(t[r]!==s)return!1;return!0}function pe(t,e,...r){const s=t.$;F(!0,e,r,s)}function M(t,e,r){if(r.component)F(!1,t,e,r.component);else if(Array.isArray(r.children))for(const s of r.children)C(s)&&M(t,e,s)}function F(t,e,r,s){const n=s.proxy;!t&&n[e]?n[e].apply(n,r):M(e,r,s.subTree)}function J(){return new Promise(t=>{te(t)})}async function $(t){return new Promise(e=>setTimeout(e,t))}function ye(t,e){if(e instanceof d)return t;if(t.$.type!==e)throw new Error("type mismatch");return t}function V(t){let e=this&&this.Resource!==d?this:void 0;return{as(r){const s=n=>{const i=[];for(const l of t.affectedTables){const f=R.get(l);for(const m of f||[])i.push(m.newRequest())}const u=t.command||r,a=new Q(u,n);return c.rpcProvider(i,a),a.promise};return x(p({},e),{[r]:s,defineCommand:V})}}}function D(t,e){return y(new d(t,e))}class g{constructor(){o(this,"buffered",[]);o(this,"flushing")}execute(e){this.buffered.push(e),this.buffered.length===1&&(this.flushing=this.flush())}async flush(){await J();const e=this.buffered;this.buffered=[],await c.rpcProvider(e),this.flushing=void 0}}o(g,"key",Symbol());class ge{constructor(e,r){o(this,"result",O({loading:!1,data:[],error:void 0,_query:this}));o(this,"criteria",{});o(this,"version",0);o(this,"queryBuffer");this.resource=e;const s=E();this.queryBuffer=s.appContext.provides[g.key],A(()=>{r&&(this.criteria=r()),c.hydrate&&!s.isMounted||this.queryBuffer.execute(this.newRequest(!s.isMounted))})}newRequest(e){return this.version++,new I(this,!!e)}refresh(){this.queryBuffer.execute(this.newRequest())}}class d{constructor(e,r){o(this,"pickedFields");o(this,"subResources",{});this.table=e,this.options=r}clone(){const e=new d(this.table,this.options);return e.pickedFields=this.pickedFields,e.subResources=p({},this.subResources),e}pick(...e){const r=this.clone();return r.pickedFields=e,y(r)}load(e,r,s,n){const i=this.clone();return i.subResources[e]={single:!0,resource:r,dynamicCriteria:s,staticCriteria:n==null?void 0:n.staticCriteria},y(i)}query(e,r,s,n){const i=this.clone();return i.subResources[e]={resource:r,dynamicCriteria:s,staticCriteria:n==null?void 0:n.staticCriteria},y(i)}toJSON(){var e;return{table:this.table,staticCriteria:(e=this.options)==null?void 0:e.staticCriteria,subResources:Object.keys(this.subResources).length===0?void 0:this.subResources}}}function H(t,e){const r=new ge(q(t),e);return E().scope.run(()=>{let s=R.get(t.table);s||R.set(t.table,s=new Set),s.add(r),re(()=>{s.delete(r)})}),r.result}class I{constructor(e,r){o(this,"baseVersion");o(this,"criteria");o(this,"showingLoading");this.query=e,this.showLoading=r,this.baseVersion=e.version,this.criteria=e.criteria,r&&!c.dehydrate&&(c.loadingPreDelay?$(c.loadingPreDelay||0).then(()=>{this.showingLoading=this.loadingCountdown()}):this.showingLoading=this.loadingCountdown())}async loadingCountdown(){this.isExpired||(this.query.result.value={loading:!0,data:[],error:void 0},await $(c.loadingPostDelay||0))}get resource(){return this.query.resource}get isExpired(){return this.baseVersion!==this.query.version}resolve(e,r){if(!this.isExpired){if(this.showingLoading){this.showingLoading.then(()=>{this.showingLoading=void 0,this.resolve(e,r)});return}this.query.version++,this.query.result.value={loading:!1,data:e,error:void 0,stale:r}}}reject(e){if(!this.isExpired){if(this.showingLoading){this.showingLoading.then(()=>{this.showingLoading=void 0,this.reject(e)});return}this.query.version++,this.query.result.value={loading:!1,data:[],error:e}}}toJSON(){return{resource:this.resource,criteria:this.criteria}}}class Q{constructor(e,r){o(this,"promise");o(this,"resolve");o(this,"reject");o(this,"responded",!1);this.command=e,this.args=r,this.promise=new Promise((s,n)=>{this.resolve=i=>{this.responded||(this.responded=!0,s(i))},this.reject=i=>{this.responded||(this.responded=!0,n(i))}})}toJSON(){return{command:this.command,args:this.args}}}var N=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",install:ce,animate:le,pageOf:de,load:fe,query:_,walk:pe,waitNextTick:J,sleep:$,castTo:ye,defineCommand:V,defineResource:D,Resource:d,QueryRequest:I,CommandRequest:Q});var me=(t,e)=>{const r=t.__vccOpts||t;for(const[s,n]of e)r[s]=n;return r};const ve=D("article"),we=se({data(){return{color:"black",articles:_(ve,()=>({language:"en"}))}}});function be(t,e,r,s,n,i){return b(),w(P,null,[L("ul",null,[(b(!0),w(P,null,ne(t.articles.data,u=>(b(),w("li",{style:ie({color:t.color})},oe(u.title),5))),256))]),L("button",{onClick:e[0]||(e[0]=u=>t.color="red")},"change color")],64)}var T=me(we,[["render",be]]);async function qe(){const t=j(T);t.use(N,{dehydrate:!0,async rpcProvider(s){s[0]&&s[0].resolve([{title:"Zen and the Art of Motorcycle Maintenance: An Inquiry into Values",language:"en"},{title:"The Hitchhikers Guide to the Galaxy",language:"en"}])}});const e=await ae(t);console.log("server rendered",e),document.getElementById("app").innerHTML=e;const r=j(T);r.use(N,{hydrate:!0,rpcProvider(){throw new Error("demo client can not rpc")}}),r.mount("#app")}qe();
