var re=Object.defineProperty,se=Object.defineProperties;var ne=Object.getOwnPropertyDescriptors;var D=Object.getOwnPropertySymbols;var ie=Object.prototype.hasOwnProperty,oe=Object.prototype.propertyIsEnumerable;var C=(t,e,r)=>e in t?re(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,m=(t,e)=>{for(var r in e||(e={}))ie.call(e,r)&&C(t,r,e[r]);if(D)for(var r of D(e))oe.call(e,r)&&C(t,r,e[r]);return t},A=(t,e)=>se(t,ne(e));var a=(t,e,r)=>(C(t,typeof e!="symbol"?e+"":e,r),r);import{r as b,t as x,i as ae,a as P,h as ce,b as j,K as ue,c as de,n as le,g as J,e as fe,o as pe,d as g,f as v,j as N,k as d,l as V,m as M,F as T,p as L,q as S,s as _,u as he}from"./vendor.9f5a4ccd.js";const ye=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const c of i.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&n(c)}).observe(document,{childList:!0,subtree:!0});function r(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerpolicy&&(i.referrerPolicy=s.referrerpolicy),s.crossorigin==="use-credentials"?i.credentials="include":s.crossorigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(s){if(s.ep)return;s.ep=!0;const i=r(s);fetch(s.href,i)}};ye();const u={rpcProvider(){throw new Error("must install with rpcProvider before query or call")}},k=new Map;function ve(t,e){const r=new w;t.provide(w.key,r),Object.assign(u,e),t.mixin({created(){if(u.dehydrate||u.hydrate){const i=this.$.render;this.$.render=function(...c){let o=i.apply(this,c);const l={},f={};for(const[p,y]of Object.entries(x(this.$.data)))ae(y)&&y.value&&y.value.data&&((y.value.stale?f:l)[p]=y.value.data);return Object.keys(f).length===0&&Object.keys(l).length===0||((!P(o)||typeof o.type!="string")&&(o=ce(u.wrapperComponent||"div",o)),u.hydrate)||(o.props||(o.props={}),o.props["data-dehydrated"]=JSON.stringify(l),o.props["data-stale"]=JSON.stringify(f)),o}}const n=this.$.type;let s=n.instanceCount;s||(s=n.instanceCount=j(0)),s.value++},beforeMount(){var c,o,l,f;if(!u.hydrate)return;const n=x(this.$.data),s=JSON.parse(((o=(c=this.$el)==null?void 0:c.dataset)==null?void 0:o.dehydrated)||"{}"),i=JSON.parse(((f=(l=this.$el)==null?void 0:l.dataset)==null?void 0:f.stale)||"{}");for(const p of Object.keys(i))n[p].value._query&&n[p].value._query.refresh();for(const[p,y]of Object.entries(m(m({},s),i)))n[p].value={loading:!1,data:y}},async serverPrefetch(){await r.flushing},unmounted(){this.$.type.instanceCount.value--}})}function me(t){return Q(t.$).proxy}function Q(t){return!t.parent||t.parent.type===ue?t:Q(t.parent)}function ge(t,e){if(t instanceof h){const r=z(t,e);return de(()=>{const n=r.value;return{loading:n.loading,data:n.data[0],error:n.error}})}return E(t,e)[0]}function E(t,e){if(t instanceof h)return z(t,e);const r=t;r.instanceCount||(r.instanceCount=j(0)),r.instanceCount.value;const n=[];let s;if(e.$parent)s=e.$parent.$.subTree;else if(e.$root)s=e.$root.$.subTree,delete e.$root;else throw new Error("must provide $parent or $root");return O(n,s,r,e),n}function O(t,e,r,n){if(!!e){if(e.component)e.type===r&&be(e.component.proxy,n)&&t.push(e.component.proxy),O(t,e.component.subTree,r,n);else if(Array.isArray(e.children))for(const s of e.children)P(s)&&O(t,s,r,n)}}function be(t,e){if(!e)return!0;for(const[r,n]of Object.entries(e))if(r==="$parent"){if(t.$.parent.proxy!==n)return!1}else if(t[r]!==n)return!1;return!0}function we(t,e,...r){const n=t.$;K(!0,e,r,n)}function I(t,e,r){if(r.component)K(!1,t,e,r.component);else if(Array.isArray(r.children))for(const n of r.children)P(n)&&I(t,e,n)}function K(t,e,r,n){const s=n.proxy;!t&&s[e]?s[e].apply(s,r):I(e,r,n.subTree)}function H(){return new Promise(t=>le(t))}async function B(t){return new Promise(e=>setTimeout(e,t))}function $(t,e){if(e instanceof h)return t;if(t.$.type!==e)throw new Error("type mismatch");return t}function q(t,e){return b(new h(t,e))}class h{constructor(e,r){a(this,"pickedFields");a(this,"subResources",{});this.table=e,this.options=r}clone(){const e=new h(this.table,this.options);return e.pickedFields=this.pickedFields,e.subResources=m({},this.subResources),e}pick(...e){const r=this.clone();return r.pickedFields=e,b(r)}load(e,r,n,s){const i=this.clone();return i.subResources[e]={single:!0,resource:r,dynamicCriteria:n,staticCriteria:s==null?void 0:s.staticCriteria},b(i)}query(e,r,n,s){const i=this.clone();return i.subResources[e]={resource:r,dynamicCriteria:n,staticCriteria:s==null?void 0:s.staticCriteria},b(i)}toJSON(){var e;return{table:this.table,staticCriteria:(e=this.options)==null?void 0:e.staticCriteria,subResources:Object.keys(this.subResources).length===0?void 0:this.subResources}}}function z(t,e){const r=new _e(x(t),e);return J().scope.run(()=>{const n=G(t);n.forEach(s=>F(s).add(r)),pe(()=>{n.forEach(s=>F(s).delete(r))})}),r.result}function F(t){let e=k.get(t);return e||k.set(t,e=new Set),e}function G(t){var r;let e=((r=t.options)==null?void 0:r.sourceTables)?[t.table,...t.options.sourceTables]:[t.table];for(const n of Object.values(t.subResources))e=[...e,...G(n.resource)];return e}class w{constructor(){a(this,"buffered",[]);a(this,"flushing")}execute(e){this.buffered.push(e),this.buffered.length===1&&(this.flushing=this.flush())}async flush(){await H();const e=this.buffered;this.buffered=[],await u.rpcProvider(e),this.flushing=void 0}}a(w,"key",Symbol());class _e{constructor(e,r){a(this,"result",j({loading:!1,data:[],error:void 0,_query:this}));a(this,"criteria",{});a(this,"version",0);a(this,"queryBuffer");this.resource=e;const n=J();if(this.queryBuffer=n.appContext.provides[w.key],!this.queryBuffer)throw new Error("please add app.use(vdb) to install vue-db before query");fe(()=>{r&&(this.criteria=r()),u.hydrate&&!n.isMounted||this.queryBuffer.execute(this.newRequest(!n.isMounted))})}newRequest(e){return this.version++,new U(this,!!e)}refresh(){this.queryBuffer.execute(this.newRequest())}}class U{constructor(e,r){a(this,"baseVersion");a(this,"criteria");a(this,"showingLoading");this.query=e,this.showLoading=r,this.baseVersion=e.version,this.criteria=e.criteria,r&&!u.dehydrate&&(u.loadingPreDelay?B(u.loadingPreDelay||0).then(()=>{this.showingLoading=this.loadingCountdown()}):this.showingLoading=this.loadingCountdown())}async loadingCountdown(){this.isExpired||(this.query.result.value={loading:!0,data:[],error:void 0},await B(u.loadingPostDelay||0))}get resource(){return this.query.resource}get isExpired(){return this.baseVersion!==this.query.version}resolve(e,r){if(!this.isExpired){if(this.showingLoading){this.showingLoading.then(()=>{this.showingLoading=void 0,this.resolve(e,r)});return}this.query.version++,this.query.result.value={loading:!1,data:e,error:void 0,stale:r}}}reject(e){if(!this.isExpired){if(this.showingLoading){this.showingLoading.then(()=>{this.showingLoading=void 0,this.reject(e)});return}this.query.version++,this.query.result.value={loading:!1,data:[],error:e}}}toJSON(){return{resource:this.resource,criteria:this.criteria}}}function W(t){let e=this&&this.Resource!==h?this:void 0;return{as(r){const n=s=>{const i=[];for(const l of t.affectedTables){const f=k.get(l);for(const p of f||[])i.push(p.newRequest())}const c=t.command||r,o=new X(c,s);return u.rpcProvider(i,o),o.promise};return A(m({},e),{[r]:n,defineCommand:W})}}}class X{constructor(e,r){a(this,"promise");a(this,"resolve");a(this,"reject");a(this,"responded",!1);this.command=e,this.args=r,this.promise=new Promise((n,s)=>{this.resolve=i=>{this.responded||(this.responded=!0,n(i))},this.reject=i=>{this.responded||(this.responded=!0,s(i))}})}toJSON(){return{command:this.command,args:this.args}}}var $e=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",install:ve,pageOf:me,load:ge,query:E,walk:we,waitNextTick:H,sleep:B,castTo:$,defineResource:q,Resource:h,QueryRequest:U,defineCommand:W,CommandRequest:X}),R=(t,e)=>{const r=t.__vccOpts||t;for(const[n,s]of e)r[n]=s;return r};const Y=q("district").pick("name"),qe=g({props:{district:{default:$(void 0,Y)}}});function Re(t,e,r,n,s,i){return d(),v("div",null,"District: "+N(t.district.name),1)}var Ce=R(qe,[["render",Re]]);const Z=q("city").query("districts",Y,{cityId:"$parent.id"}),xe=g({props:{city:{default:$(void 0,Z)}},components:{DistrictBox:Ce}}),ke={style:{"margin-left":"32px"}};function Oe(t,e,r,n,s,i){const c=S("DistrictBox");return d(),v("div",null,[V(" City: "+N(t.city.name)+" ",1),M("div",ke,[(d(!0),v(T,null,L(t.city.districts,o=>(d(),_(c,{district:o},null,8,["district"]))),256))])])}var Be=R(xe,[["render",Oe]]);const ee=q("province").query("cities",Z,{provinceId:"$parent.id"}),Pe=g({props:{province:{default:$(void 0,ee)}},components:{CityBox:Be}}),je={style:{"margin-left":"32px"}};function Ne(t,e,r,n,s,i){const c=S("CityBox");return d(),v("div",null,[V(" Province: "+N(t.province.name)+" ",1),M("div",je,[(d(!0),v(T,null,L(t.province.cities,o=>(d(),_(c,{city:o},null,8,["city"]))),256))])])}var Te=R(Pe,[["render",Ne]]);const Le=g({data(){return{provinces:E(ee)}},components:{ProvinceBox:Te}});function Se(t,e,r,n,s,i){const c=S("ProvinceBox");return d(!0),v(T,null,L(t.provinces.data,o=>(d(),_(c,{province:o},null,8,["province"]))),256)}var Ee=R(Le,[["render",Se]]);const De=g({setup(t){return(e,r)=>(d(),_(Ee))}}),te=he(De);te.use($e,{rpcProvider:async t=>{console.log("queries",JSON.stringify(t,void 0,"  ")),t[0].resolve([{id:"1",name:"jiangxi",cities:[{id:"2",name:"nanchang",districts:[{id:"3",name:"xihu"},{id:"4",name:"donghu"},{id:"5",name:"xinjian"}]}]},{id:"6",name:"jilin"}])}});te.mount("#app");
